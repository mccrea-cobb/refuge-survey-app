---
title:  |
    | Annual Report of Survey Activities on Refuges  
    |
    | ![](bear.jpg){width=7in}
output:
  pdf_document:
    latex_engine: xelatex
    number_sections: no
    includes:
      in_header: latex/header.tex
      before_body: latex/before_body.tex 
      after_body: latex/after_body.tex
    toc: yes
    toc_depth: 2
urlcolor: blue
---

\newpage

\pagenumbering{arabic}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(tidyverse)
library(kableExtra)
```


```{r import_format, echo=F, warning=F, message=F}
# Load the survey data locally
# load("./data/dat.Rdata")

source("R/global.R")

region_num <- 7 
year_selected <- 2021
region <- regions$region_name[[region_num]]

# Load the survey data 
load("./data/input_dat.Rdata")
# input_dat <- primr_dat_ws(region_num)

dat <- input_dat %>%
      unnest(reports, keep_empty = TRUE) %>%
      distinct(surveyId, .keep_all = T)
dat <- unnest(dat, Conducted, keep_empty = TRUE)
dat <- dat %>% filter(year == year_selected)
```

---
subtitle: |
  |
  |
  |
  |
  |
  | National Wildlife Refuge System
  | `r region` Region
  | `r year_selected`
---

# Summary Information  

This report summarizes survey activity on National Wildlife Refuges in the `r region` Region in `r year_selected`. The information used in this report originates from PRIMR, a database that stores descriptions of refuge surveys. Refuge staff populate PRIMR with their historic, current and planned surveys. This information is used to generate the refuge's Inventory and Monitoring Plan. Annually, refuge staff are asked to update PRIMR. As a part of this effort, Survey Coordinators (generally a refuge biologist) enter whether each current survey was completed and, if it was not, the reason that is was not completed.

```{r tbl_activity, echo=F, message=F}

# Completed surveys
complete <- dat %>% 
  filter(isSurveyConducted == "true") %>%
  group_by(StationName) %>% 
  tally()

# Incomplete surveys
incomplete <- dat %>% 
  filter(isSurveyConducted == "false") %>%
  group_by(StationName) %>% 
  tally()

current <- input_dat %>%
  filter(SurveyStatus == "Current" | endYear == year_selected) %>%
  count(StationName)
  

# Merge them
tbl <- merge(complete, incomplete, by = "StationName", all = T) %>%
  merge(current, by = "StationName", all = T) %>%
  rename("complete" = n.x,
         "incomplete" = n.y,
         "current" = n) %>%
  mutate(complete = as.integer(complete),
         incomplete = as.integer(incomplete),
         current = as.integer(current))

# Add back refuges that have no activity data and mark them as "Unknown"
refuges <- data.frame("StationName" = levels(tbl$StationName))

tbl <- merge(tbl, refuges, by = "StationName", all.y = T) %>%
  # Add a TOTAL row
  bind_rows(summarise(.,
                      across(where(is.numeric), sum, na.rm = T),
                      across(where(is.factor), ~"TOTAL"))) %>%
  # Add a reported row (reporting rate)
  rowwise() %>%
  mutate(reported = sum(complete, incomplete, na.rm = T) / current,
         reported = scales::label_percent()(reported),
         complete = replace(complete, is.na(complete), "--"),
         incomplete = replace(incomplete, is.na(incomplete), "--")) %>%
  # Reorder the columns
  select(StationName, current, reported, complete, incomplete)

# Create a formatted table
tbl %>% kbl(col.names = c("Refuge", "Current surveys", "Reporting rate", "Completed surveys", "Not completed surveys"),
            longtable = T, 
            caption = paste("Summary of survey activity at National Wildlife Refuges in the", region, "Region in 2021. Surveys are considered completed if data are collected for 75\\% or more of the scheduled sample sites in the given calendar year. Reporting rate indicates the percentage of current surveys at a refuge that had been reported as completed or not completed in PRIMR."),
            booktabs = T) %>%
  kable_styling(latex_options = c("striped", 
                                  "HOLD_position",
                                  "repeat_header"),
                position = "left")
```

  
```{r tbl_reasons, echo=F, message=F}
covid_comments <- sum(str_count(dat$comment, "(?i)covid"), na.rm=T)  # (?i) = ignore case sensitivity

dat %>%
  filter(isSurveyConducted == "false") %>%
  group_by(reason) %>%
  tally() %>%
  arrange(-n) %>%
  kbl(col.names = c("Reason", "n"),      
      longtable = T, 
      caption = paste0("Summary of reasons for why surveys were not completed at National Wildlife Refuges in the", region, " Region in ", year_selected, ". ", "COVID-related restrictions were described as the primary reason that surveys were not completed under the Administrative and Weather and Disturbance categories, preventing a total of ", covid_comments, " surveys from being completed."),
      booktabs = T) %>%
  kable_styling(latex_options = c("striped", 
                                  "HOLD_position",
                                  "repeat_header"),
                position = "left")
```

  
```{r tbl_biotic_grp1, echo=F, message=F}

# Unnest derivedBioticGroupLevel1
derived <- dat %>%
  unnest(derivedBioticGroupLevel1, keep_empty = TRUE) %>%
  filter(isSurveyConducted == "true") %>%
  select(StationName, SurveyName, scientificName, commonName)

# Unnest bioticGroupLevel1
bio_grps <- dat %>%
  unnest(bioticGroupLevel1, keep_empty = TRUE) %>%
  filter(isSurveyConducted == "true") %>%
  select(StationName, SurveyName, scientificName, commonName)

# Combine them and keep distinct values, remove NAs
bio1 <- rbind(derived, bio_grps)
bio1 <- bio1 %>%
  distinct()

bio1 <- bio1 %>%
  group_by(scientificName, commonName) %>%
  tally() %>%
  ungroup() %>%
  mutate(commonName = tolower(commonName),
         bio_grp = paste(scientificName, " (", commonName, ")", sep = ""),
         bio_grp = replace(bio_grp, bio_grp == "NA (NA)", "Unknown")) %>%
  select(c(bio_grp, n)) %>%
  arrange(-n)

kbl(bio1,
    longtable = T,
    col.names = c("Biotic group (Level 1)", "n"),
    caption = paste("Summary of biotic groups (Level 1) that were targeted or influenced by surveys completed at National Wildlife Refuges in the", region, "Region in 2021. Level 1 is a high level taxonomic category ranging from Class to Kingdom. Unknown values indicate surveys without a biotic group (Level 1) specified in PRIMR."),
    booktabs = T) %>%
  kable_styling(latex_options = c("striped", 
                                  "HOLD_position",
                                  "repeat_header"),
                position = "left")
```


```{r plot_bio_grp1, echo=F, message=F, fig.cap=paste("Summary of biotic groups (Level 1) that were targeted or influenced by surveys completed at National Wildlife Refuges in the", region, "Region in 2021. Level 1 is a high level taxonomic category ranging from Class to Kingdom.")}

bio1 %>%
  # filter and reorder the data
  filter(bio_grp != "Unknown") %>%
  arrange(-n) %>%
  mutate(bio_grp = factor(bio_grp, levels = bio_grp)) %>%  # This trick updates the factor level order
  # plot it
  ggplot(aes(x = bio_grp, y = n)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  geom_text(aes(label = n), vjust = -1.5, color = "black", size = 2.5) +
  theme_minimal() +
  xlab("Biotic groups (Level 1)") +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
```

  
```{r tbl_biotic_grp2, echo=F, message=F, fig.align='left'}

## Biotic group, level 2
  # Unnest derivedBioticGroupLevel2
derived <- dat %>%
  unnest(derivedBioticGroupLevel2, keep_empty = TRUE) %>%
  filter(isSurveyConducted == "true") %>%
  select(StationName, SurveyName, scientificName, commonName)

# Unnest bioticGroupLevel2
bio_grps <- dat %>%
  unnest(bioticGroupLevel2, keep_empty = TRUE) %>%
  filter(isSurveyConducted == "true") %>%
  select(StationName, SurveyName, scientificName, commonName)

# Combine them and keep distinct values, remove NAs
bio2 <- rbind(derived, bio_grps)
bio2 <- bio2 %>%
  distinct()

bio2 <- bio2 %>%
  group_by(scientificName, commonName) %>%
  tally() %>%
  ungroup() %>%
  mutate(commonName = tolower(commonName),
         bio_grp = paste(scientificName, " (", commonName, ")", sep = ""),
         bio_grp = replace(bio_grp, bio_grp == "NA (NA)", "Unknown")) %>%
  select(c(bio_grp, n)) %>%
  arrange(-n)

kbl(bio2, 
    longtable = T, 
    col.names = c("Biotic group (Level 2)", "n"),
    caption = paste("Summary of biotic groups (Level 2) that were targeted or influenced by surveys completed at National Wildlife Refuges in the", region, "Region in 2021. Level 2 is a mid-level taxonomic category ranging from Family to Order. Unknown values indicate surveys without a biotic group (Level 2) specified in PRIMR."),
    booktabs = T) %>%
  kable_styling(latex_options = c("striped", 
                                  "HOLD_position",
                                  "repeat_header"),
                position = "left")
```

  
```{r tbl_biotic_grp_combined, echo=F, message=F}
## Biotic group, level 2
  # Unnest derivedBioticGroupLevel2
# derived <- dat %>%
#   unnest(derivedBioticGroupLevel1, keep_empty = TRUE) %>%
#   unnest(derivedBioticGroupLevel2, keep_empty = TRUE, names_repair = "unique") %>%
#   rename(scientificName1 = scientificName...26,
#          scientificName2 = scientificName...28,
#          commonName1 = commonName...27,
#          commonName2 = commonName...29) %>%
#   filter(isSurveyConducted == "true") %>%
#   select(StationName, SurveyName, scientificName1, commonName1, scientificName2, commonName2)
# 
# # Unnest bioticGroupLevel2
# bio_grps <- dat %>%
#   unnest(bioticGroupLevel1, keep_empty = TRUE) %>%
#   unnest(bioticGroupLevel2, keep_empty = TRUE, names_repair = "unique") %>%
#   rename(scientificName1 = scientificName...24,
#          scientificName2 = scientificName...26,
#          commonName1 = commonName...25,
#          commonName2 = commonName...27) %>%
#   filter(isSurveyConducted == "true") %>%
#   select(StationName, SurveyName, scientificName1, commonName1, scientificName2, commonName2)
# 
# # Combine them and keep distinct values, remove NAs
# foo <- rbind(derived, bio_grps)
# foo <- foo %>%
#   distinct()
# 
# foo <- foo %>%
#   group_by(scientificName1, commonName1, scientificName2, commonName2) %>%
#   tally() %>%
#   ungroup() %>%
#   mutate(commonName = tolower(commonName),
#          bio_grp = paste(scientificName, " (", commonName, ")", sep = ""),
#          bio_grp = replace(bio_grp, bio_grp == "NA (NA)", "Unknown")) %>%
#   select(c(bio_grp, n)) %>%
#   arrange(-n)
#   
#   kbl(foo, longtable = T, col.names = c("Biotic group (Level 2)", "n"),
#       caption = "Summary of biotic groups (Level 2) that were targeted or influenced by surveys completed at National Wildlife Refuges in the Alaska Region in 2021. Level 2 is a mid-level taxonomic category ranging from Family to Order. Unknown values indicate surveys without a biotic group (Level 2) specified in PRIMR.",
#       booktabs = T) %>%
#     kable_styling(latex_options = c("striped", 
#                                     "hold_position",
#                                     "repeat_header"),
#                   position = "left")
```


\newpage

# Survey Conducted in the `r region` Region in `r year_selected`  

The following lists refuge surveys that are scheduled in reported in PRIMR as completed in the `r region` region in `r year_selected` Surveys are considered completed if data are collected for 75% or more of the scheduled sample sites in the given calendar year. 

```{r refuge_summaries, echo=F, results='asis'}

foo <- dat %>% 
  filter(isSurveyConducted == "true") %>%
  droplevels() %>%
  mutate(servCatUrl = replace_na(servCatUrl, "(No ServCat project record)"),
         answerQuestion2.text = replace_na(answerQuestion2.text, "(Not entered)"),
         StationName = toupper(paste(StationName, "Refuge")),
         ProtocolTitle = as.character(ProtocolTitle),
         ProtocolTitle = replace_na(ProtocolTitle, ("(No protocol)")))
foo <- split(foo, foo$StationName)


for (i in (1:length(foo))) {
  cat("\n")
  cat("##", names(foo[i]), "\n")
  for(t in (1:length(foo[[i]]$SurveyName))) {
    cat("### ", "[", foo[[i]]$SurveyName[t], "](https://ecos.fws.gov/primr/survey/edit/", foo[[i]]$id[t], ")", " \n", sep = "")
    cat("**Survey record:** https://ecos.fws.gov/primr/survey/edit/", foo[[i]]$id[t], "\n", sep = "")
    cat("\n")
    cat("**Survey type:**", foo[[i]]$SurveyType[t], "\n")
    cat("\n")
    cat("**Frequency:**", foo[[i]]$Frequency[t], "\n")
    cat("\n")
    cat("**Products:**", foo[[i]]$servCatUrl[t], "\n")
    cat("\n")
    if(foo[[i]]$ProtocolTitle[t] != "(No protocol)") {
      cat("**Protocol:** ", "[", foo[[i]]$ProtocolTitle[t], "](https://ecos.fws.gov/ServCat/Reference/Profile/", foo[[i]]$protocol.servCatId[t], ")", " \n", sep = "")
      } else {
        cat("**Protocol:** (No Protocol)", "\n")}
    cat("\n")
    cat("**Survey Coordinator:** ", foo[[i]]$coordinatorName[t], " (", foo[[i]]$coordinatorTitle[t], ")", "\n", sep = "")
    cat("\n")
    cat("**Email:**", foo[[i]]$coordinatorEmail[t], "\n")
    cat("\n")
    cat("**Why is it important to conduct this survey?**", foo[[i]]$answerQuestion2.text[t], "\n")
    cat("\n")
  }
  cat("\n")
  cat("\\newpage")
}
```

\newpage

# R Session Info

```{r session_info, results='asis', echo=F}
sessionInfo()
```

